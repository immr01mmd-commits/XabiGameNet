from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, CallbackContext
import random
import json
import os

# Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†
if os.path.exists("players.json"):
    with open("players.json", "r", encoding="utf-8") as f:
        players = json.load(f)
else:
    players = {}

# ======== Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ ========
def start(update: Update, context: CallbackContext):
    user = update.effective_user
    if str(user.id) not in players:
        players[str(user.id)] = {"coins":0, "level":1, "skin":"ğŸ‘·", "power":1}
        save_players()
    
    update.message.reply_text(
        f"Ø³Ù„Ø§Ù… {user.first_name}! â›ï¸ Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ù…Ø§ÛŒÙ†Ø±!",
        reply_markup=main_menu()
    )

def main_menu():
    keyboard = [
        [InlineKeyboardButton("â›ï¸ Ù…Ø§ÛŒÙ† Ú©Ù†", callback_data="mine"),
         InlineKeyboardButton("ğŸ›’ Ø´Ø§Ù¾", callback_data="shop")],
        [InlineKeyboardButton("ğŸ† Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯", callback_data="leaderboard"),
         InlineKeyboardButton("ğŸ“Š ÙˆØ¶Ø¹ÛŒØª", callback_data="status")]
    ]
    return InlineKeyboardMarkup(keyboard)

# ======== Ù…Ø§ÛŒÙ†ÛŒÙ†Ú¯ ========
def mine(update: Update, context: CallbackContext):
    query = update.callback_query
    user_id = str(query.from_user.id)
    query.answer()

    power = players[user_id]["power"]
    coins_earned = random.randint(1,5) * power
    players[user_id]["coins"] += coins_earned
    save_players()

    query.edit_message_text(
        text=f"{players[user_id]['skin']} Ø´Ù…Ø§ Ù…Ø§ÛŒÙ† Ú©Ø±Ø¯ÛŒØ¯ Ùˆ {coins_earned} Ø³Ú©Ù‡ Ú¯Ø±ÙØªÛŒØ¯!\nÚ©Ù„ Ø³Ú©Ù‡â€ŒÙ‡Ø§: {players[user_id]['coins']}",
        reply_markup=main_menu()
    )

# ======== Ø´Ø§Ù¾ ========
shop_items = {
    "ğŸ› ï¸ Ø§Ø¨Ø²Ø§Ø± Ù‚ÙˆÛŒ": {"price":50, "power":2},
    "ğŸ’ Ø§Ø¨Ø²Ø§Ø± ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡": {"price":200, "power":5},
    "ğŸ‘· Ø§Ø³Ú©ÛŒÙ† Ø¬Ø¯ÛŒØ¯": {"price":100, "skin":"ğŸ§‘â€ğŸ­"}
}

def shop(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    keyboard = [[InlineKeyboardButton(f"{item} - {info['price']} Ø³Ú©Ù‡", callback_data=f"buy_{item}")] for item, info in shop_items.items()]
    query.edit_message_text("ğŸ›’ Ø´Ø§Ù¾ Ù…Ø§ÛŒÙ†Ø±:", reply_markup=InlineKeyboardMarkup(keyboard))

def buy(update: Update, context: CallbackContext):
    query = update.callback_query
    user_id = str(query.from_user.id)
    query.answer()
    item_name = query.data.split("_",1)[1]
    item = shop_items[item_name]

    if players[user_id]["coins"] >= item["price"]:
        players[user_id]["coins"] -= item["price"]
        if "power" in item:
            players[user_id]["power"] = item["power"]
        if "skin" in item:
            players[user_id]["skin"] = item["skin"]
        save_players()
        text = f"Ø®Ø±ÛŒØ¯ Ù…ÙˆÙÙ‚! ğŸ‰ {item_name} Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯."
    else:
        text = "âŒ Ø³Ú©Ù‡ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª."

    query.edit_message_text(text=text, reply_markup=main_menu())

# ======== Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ ========
def leaderboard(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    top_players = sorted(players.items(), key=lambda x: x[1]["coins"], reverse=True)[:10]
    text = "ğŸ† Ù„ÛŒØ¯Ø±Ø¨ÙˆØ±Ø¯ Ø¬Ù‡Ø§Ù†ÛŒ:\n"
    for i, (uid, data) in enumerate(top_players,1):
        text += f"{i}. {data['skin']} {uid} - {data['coins']} Ø³Ú©Ù‡\n"
    query.edit_message_text(text=text, reply_markup=main_menu())

# ======== Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª ========
def status(update: Update, context: CallbackContext):
    query = update.callback_query
    query.answer()
    user_id = str(query.from_user.id)
    data = players[user_id]
    query.edit_message_text(
        f"ğŸ‘¤ Ø´Ù…Ø§: {data['skin']}\nØ³Ø·Ø­: {data['level']}\nÙ‚Ø¯Ø±Øª: {data['power']}\nØ³Ú©Ù‡â€ŒÙ‡Ø§: {data['coins']}",
        reply_markup=main_menu()
    )

# ======== Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ ========
def save_players():
    with open("players.json", "w", encoding="utf-8") as f:
        json.dump(players, f, ensure_ascii=False, indent=4)

# ======== Ù‡Ù†Ø¯Ù„Ø± Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ========
def button(update: Update, context: CallbackContext):
    query = update.callback_query
    data = query.data
    if data == "mine":
        mine(update, context)
    elif data == "shop":
        shop(update, context)
    elif data.startswith("buy_"):
        buy(update, context)
    elif data == "leaderboard":
        leaderboard(update, context)
    elif data == "status":
        status(update, context)

# ======== main ========
def main():
    updater = Updater("YOUR_BOT_TOKEN", use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CallbackQueryHandler(button))

    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
